<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶≤‡ßç‡¶ü‡¶ø‡¶Æ‡ßá‡¶ü</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3737/3737151.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#0f172a', card: '#1e293b', text: '#f1f5f9' },
                        primary: '#3b82f6',
                        secondary: '#6366f1'
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Hind Siliguri', sans-serif; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .sugg-chip { 
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .sugg-chip:active { transform: scale(0.95); }
        .input-field { @apply transition duration-150 ease-in-out; }
        .input-error { @apply border-red-500 ring-red-200 ring-4 dark:ring-red-900/40; }
        
        .input-group-btn {
            @apply bg-primary text-white px-3 text-sm font-bold active:scale-95 transition-colors hover:bg-blue-700;
            flex-shrink: 0; 
        }
        
        .menu-item { @apply w-full text-left p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 font-medium flex items-center gap-3 transition dark:text-gray-200 text-gray-700; }
        .input-field { @apply w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-primary dark:text-white transition; }
        .quick-btn { @apply bg-gray-100 dark:bg-gray-700 py-2 rounded-lg text-sm font-bold dark:text-white hover:bg-gray-200 dark:hover:bg-gray-600 transition; }
        .modal-content { @apply bg-white dark:bg-dark-card rounded-2xl w-full max-w-sm p-6 shadow-2xl scale-95 opacity-0 transition-all duration-300; }
        .sugg-chip { @apply flex-shrink-0 px-4 py-2 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-full text-sm font-medium hover:bg-primary/10 dark:hover:bg-gray-600 hover:border-primary transition shadow-sm active:scale-95 dark:text-gray-200; }

        .history-item-detail {
            @apply bg-white dark:bg-gray-700 p-3 rounded-xl shadow-sm flex justify-between items-center transition duration-200 hover:shadow-md border border-gray-100 dark:border-gray-600;
        }

        /* Calculator Styles */
        .calc-btn { 
            @apply w-full aspect-square text-2xl font-bold rounded-xl active:opacity-80 transition duration-100 shadow-md; 
        }
        .calc-digit { 
            @apply bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600; 
        }
        .calc-operator { 
            @apply bg-primary/80 text-white dark:bg-primary/60 dark:text-white hover:bg-primary/90 dark:hover:bg-primary/70; 
        }
        .calc-misc { 
             @apply bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-400 dark:hover:bg-gray-500;
        }
        
        .tag-pill { @apply px-3 py-1 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 text-xs font-bold rounded-full; }
        .note-item-analyzed { @apply p-3 bg-white dark:bg-gray-700 rounded-lg shadow-sm flex justify-between items-center transition hover:shadow-md cursor-pointer border-l-4 border-primary dark:border-blue-400; }
        .note-item-manual { @apply border-l-4 border-red-500 dark:border-red-400; } 
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-dark-bg dark:text-dark-text min-h-screen pb-28 transition-colors duration-300">

    <div class="bg-primary shadow-lg sticky top-0 z-50 px-4 py-3 flex justify-between items-center transition-colors duration-300">
        <div class="flex items-center gap-2">
            <button id="globalBackBtn" onclick="goBack()" class="hidden text-white/90 w-8 h-8 rounded-full hover:bg-blue-700/50 transition"><i class="fas fa-arrow-left text-xl"></i></button>
            <h1 class="font-bold text-xl text-white transition-all" id="pageTitle">
                <i class="fas fa-cart-shopping mr-1 text-white"></i>‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞
            </h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleDarkMode()" class="w-9 h-9 rounded-full bg-blue-700 flex items-center justify-center text-yellow-300 transition transform active:scale-95 shadow-inner">
                <i class="fas fa-moon" id="themeIcon"></i>
            </button>
            <button onclick="toggleMenu()" class="text-white p-2 active:scale-95 transition"><i class="fas fa-bars text-xl"></i></button>
        </div>
    </div>

    <div id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white dark:bg-dark-card shadow-2xl transform -translate-x-full transition-transform duration-300 z-[60]">
        <div class="p-6 bg-gradient-to-br from-primary to-secondary text-white flex flex-col">
            <h2 class="font-bold text-2xl mb-1">‡¶Ü‡¶∏‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ‡ßÅ ‡¶Ü‡¶≤‡¶æ‡¶á‡¶ï‡ßÅ‡¶Æ üëã</h2>
            <p class="text-lg font-medium" id="menuUserName">‡¶¨‡¶®‡ßç‡¶ß‡ßÅ</p>
            <p class="text-xs opacity-80 mt-2">‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶® ‡ß´.‡ß¶ (‡¶Ü‡¶≤‡ßç‡¶ü‡¶ø‡¶Æ‡ßá‡¶ü ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞)</p>
        </div>
        <nav class="p-4 space-y-2 max-h-[80vh] overflow-y-auto scrollbar-hide">
            <button onclick="editProfile(); toggleMenu()" class="menu-item"><i class="fas fa-user-edit text-primary w-8"></i> ‡ßß. ‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</button>
            <button onclick="openWalletModal(); toggleMenu()" class="menu-item"><i class="fas fa-wallet text-green-500 w-8"></i> ‡ß®. ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°</button>
            <button onclick="goToWishlistPage(); toggleMenu()" class="menu-item"><i class="fas fa-heart text-pink-500 w-8"></i> ‡ß©. ‡¶™‡¶∞‡ßá ‡¶ï‡¶ø‡¶®‡¶¨</button>
            <button onclick="goToHistoryPage(); toggleMenu()" class="menu-item"><i class="fas fa-clock-rotate-left text-purple-500 w-8"></i> ‡ß™. ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</button>
            <div class="h-px bg-gray-200 dark:bg-gray-700 my-2"></div>
            <button onclick="showPage('notepad'); toggleMenu(); renderNotepad();" class="menu-item"><i class="fas fa-note-sticky text-indigo-500 w-8"></i> ‡ß´. ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶®‡ßã‡¶ü‡¶™‡ßç‡¶Ø‡¶æ‡¶°</button>
            <h4 class="text-xs font-bold text-gray-400 uppercase pt-2">‡¶Ü‡¶≤‡ßç‡¶ü‡¶ø‡¶Æ‡ßá‡¶ü ‡¶ü‡ßÅ‡¶≤‡¶∏</h4>
            <button onclick="showPage('calculator'); toggleMenu();" class="menu-item"><i class="fas fa-calculator text-yellow-500 w-8"></i> ‡ß¨. ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞</button>
            <button onclick="showPage('stats'); toggleMenu(); renderStats();" class="menu-item"><i class="fas fa-chart-pie text-red-500 w-8"></i> ‡ß≠. ‡¶Æ‡¶æ‡¶∏ ‡¶∂‡ßá‡¶∑‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
            <button onclick="openBudgetModal(); toggleMenu()" class="menu-item"><i class="fas fa-bell text-indigo-500 w-8"></i> ‡ßÆ. ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡¶æ‡¶ú‡ßá‡¶ü ‡¶∏‡ßá‡¶ü</button>
            <button onclick="showPage('price-tracker'); toggleMenu(); renderPriceTracker();" class="menu-item"><i class="fas fa-tags text-cyan-500 w-8"></i> ‡ßØ. ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶∏ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶∞</button>
            <button onclick="openCategoryManager(); toggleMenu()" class="menu-item"><i class="fas fa-list-check text-orange-500 w-8"></i> ‡ßß‡ß¶. ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</button>
            <div class="h-px bg-gray-200 dark:bg-gray-700 my-2"></div>
            <h4 class="text-xs font-bold text-gray-400 uppercase pt-2">‡¶°‡ßá‡¶ü‡¶æ ‡¶ì ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç</h4>
            <button onclick="exportData()" class="menu-item"><i class="fas fa-file-export text-green-500 w-8"></i> ‡ßß‡ßß. ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü (JSON)</button>
            <button onclick="importDataModal()" class="menu-item"><i class="fas fa-file-import text-blue-500 w-8"></i> ‡ßß‡ß®. ‡¶°‡ßá‡¶ü‡¶æ ‡¶á‡¶Æ‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
            <button onclick="alert('‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡¶§ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞: ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶°‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶®‡¶ø‡¶§‡ßá Firebase ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§')" class="menu-item"><i class="fas fa-sync-alt text-gray-500 w-8"></i> ‡ßß‡ß©. ‡¶´‡¶æ‡ßü‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï (Mock)</button>
            <button onclick="alert('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø‡¶∞ ‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶® ‡ß´.‡ß¶, ‡¶Ü‡¶≤‡ßç‡¶ü‡¶ø‡¶Æ‡ßá‡¶ü ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡•§ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶®: Gemini.')" class="menu-item"><i class="fas fa-info-circle text-gray-400 w-8"></i> ‡ßß‡ß™. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá</button>
            <div class="h-px bg-gray-200 dark:bg-gray-700 my-2"></div>
            <button onclick="resetAll()" class="menu-item text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20"><i class="fas fa-trash-alt w-8"></i> ‡¶∏‡¶¨ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</button>
        </nav>
    </div>
    <div id="overlay" onclick="toggleMenu()" class="fixed inset-0 bg-black/50 hidden z-[55] backdrop-blur-sm"></div>

    <div id="view-home" class="page-section container mx-auto max-w-lg p-4 fade-in block">
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2 font-medium" id="currentDateDisplay"></p>

        <div class="balance-card bg-gradient-to-r from-primary to-secondary text-white rounded-2xl p-6 shadow-2xl mb-6 relative overflow-hidden transition-all duration-500 group">
            <div class="relative z-10 flex justify-between items-center">
                <div>
                    <p class="text-xs opacity-80 font-medium tracking-wider mb-1">‡¶Ö‡¶¨‡¶∂‡¶ø‡¶∑‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p>
                    <h2 class="text-4xl font-bold" id="currentBalance">‡ß≥ ‡ß¶</h2>
                </div>
                <div class="text-right">
                    <p class="text-xs opacity-80 mb-1">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö</p>
                    <p class="text-xl font-bold text-yellow-300" id="todaySpent">‡ß≥ ‡ß¶</p>
                </div>
            </div>
            <div id="budgetBarContainer" class="mt-4 pt-3 border-t border-white/30 hidden">
                 <p class="text-xs opacity-90 font-medium flex justify-between">
                     <span>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡¶æ‡¶ú‡ßá‡¶ü: <span id="budgetAmountText">‡ß≥ ‡ß¶</span></span>
                     <span id="budgetRemainingText"></span>
                 </p>
                 <div class="w-full bg-white/20 h-2 rounded-full mt-1 overflow-hidden">
                     <div id="budgetProgressBar" class="h-2 bg-yellow-300 transition-all duration-500" style="width: 0%;"></div>
                 </div>
            </div>
            <div class="absolute -right-6 -bottom-6 w-32 h-32 bg-white/10 rounded-full blur-2xl group-hover:scale-110 transition duration-700"></div>
        </div>

        <div class="bg-white dark:bg-dark-card p-5 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-700 mb-6">
            <div class="flex gap-3 mb-4">
                <div class="w-2/3">
                    <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶¨‡¶æ‡¶õ‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                    <select id="itemCategory" onchange="renderSuggestions(); autoSuggestPrice();" class="w-full p-3 bg-blue-50 dark:bg-gray-800 border-none rounded-xl text-primary dark:text-blue-300 font-bold focus:ring-2 focus:ring-primary outline-none appearance-none cursor-pointer"></select>
                </div>
                <div class="w-1/3">
                    <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">‡¶Ü‡¶á‡¶ï‡¶®</label>
                    <button id="iconPickerBtn" onclick="openIconModal()" class="w-full h-12 bg-gray-100 dark:bg-gray-700 text-3xl rounded-xl flex items-center justify-center border border-gray-200 dark:border-gray-600 transition active:scale-95">
                        <span id="selectedIcon">üõí</span>
                    </button>
                </div>
            </div>

            <div class="mb-5">
                <label class="text-xs font-bold text-gray-400">‡¶ú‡¶®‡¶™‡ßç‡¶∞‡¶ø‡ßü ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ (‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®)</label>
                <div class="flex gap-2 overflow-x-auto scrollbar-hide py-2" id="suggestionContainer"></div>
            </div>

            <div class="space-y-4">
                <div class="relative">
                    <input type="text" id="itemName" oninput="autoSuggestPrice()" class="input-field w-full p-3 bg-gray-50 dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-primary dark:text-white transition pl-10 pr-10" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
                    <span class="absolute left-3.5 top-3.5 text-gray-400"><i class="fas fa-tag"></i></span>
                    <button onclick="clearInput('itemName')" class="absolute right-3.5 top-3.5 text-gray-400 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
                </div>
                <div class="relative">
                    <input type="text" id="itemTags" class="input-field w-full p-3 pl-10" placeholder="‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® (#‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø, #‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π‡ßá‡¶∞)">
                    <span class="absolute left-3.5 top-3.5 text-gray-400"><i class="fas fa-hashtag"></i></span>
                    <button onclick="alert('‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡¶§ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞: ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡ßá ‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶¶‡¶ø‡¶®‡•§')" class="absolute right-3.5 top-3.5 text-gray-400 hover:text-primary transition"><i class="fas fa-microphone"></i></button>
                </div>

                <div class="flex gap-3">
                    <div class="w-1/2">
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">‡¶¶‡¶æ‡¶Æ (‡ß≥) ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶á‡¶â‡¶®‡¶ø‡¶ü</label>
                        <div class="relative">
                            <input type="number" id="unitPrice" class="input-field w-full p-3 pl-8 font-bold text-primary" placeholder="‡ß¶" oninput="calculateLive()">
                            <span class="absolute left-3 top-3.5 text-primary font-bold">‡ß≥</span>
                        </div>
                        <div id="priceMemory" class="text-[10px] text-center w-full mt-1 bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300 px-2 py-0.5 rounded-lg hidden cursor-pointer transition-all hover:bg-yellow-200" onclick="applySuggestedPrice()"></div>
                    </div>

                    <div class="w-1/2">
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 mb-1 block">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ/‡¶ì‡¶ú‡¶®)</label>
                        <div class="flex shadow-md rounded-xl overflow-hidden">
                            <input type="number" id="weight" step="0.01" class="input-field rounded-none border-0 font-bold text-secondary focus:ring-0" placeholder="‡ß¶" oninput="calculateLive()">
                            <button onclick="cycleWeightUnit()" class="input-group-btn" id="weightUnit">‡¶ï‡ßá‡¶ú‡¶ø</button>
                        </div>
                        <div class="flex gap-1 mt-1">
                            <button onclick="quickWeightChange(0.25)" class="quick-btn w-1/3">+‡ß¶.‡ß®‡ß´</button>
                            <button onclick="quickWeightChange(0.5)" class="quick-btn w-1/3">+‡ß¶.‡ß´</button>
                            <button onclick="quickWeightChange(1)" class="quick-btn w-1/3">+‡ßß</button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-800 p-3 rounded-xl border border-dashed border-gray-300 dark:border-gray-600">
                    <span class="text-sm text-gray-500 font-bold">‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö:</span>
                    <span class="text-2xl font-bold text-primary dark:text-blue-400" id="liveCost">‡ß≥ ‡ß¶</span>
                </div>

                <div class="pt-2 border-t dark:border-gray-700">
                    <label class="text-xs font-bold text-gray-500 mb-1 block">‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡¶¶‡¶æ‡¶∞‡¶ï‡ßá ‡¶¶‡¶ø‡¶≤‡ßá‡¶® (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤)</label>
                    <div class="flex gap-3 items-center">
                        <input type="number" id="givenAmount" class="flex-1 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-yellow-500 dark:text-white" placeholder="‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¶‡¶ø‡¶≤‡ßá‡¶®?" oninput="calculateLive()">
                        <div id="changeBadge" class="hidden px-4 py-2 rounded-xl text-center min-w-[100px] transition-all duration-300">
                            <p class="text-[10px] font-bold uppercase tracking-wider" id="changeLabel">‡¶´‡ßá‡¶∞‡¶§</p>
                            <p class="text-lg font-bold" id="changeAmount">‡ß≥ ‡ß¶</p>
                        </div>
                    </div>
                </div>

                <button onclick="addItem()" class="w-full bg-gradient-to-r from-primary to-secondary text-white font-bold py-4 rounded-xl hover:shadow-lg hover:shadow-primary/40 active:scale-95 transition flex justify-center items-center gap-2 text-lg">
                    <i class="fas fa-plus-circle"></i> ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>

        <div class="mb-28">
            <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-3 flex items-center justify-between">
                <span>
                    <span class="bg-primary/20 dark:bg-primary/40 text-primary dark:text-white w-6 h-6 flex items-center justify-center rounded-full text-xs inline-flex mr-2" id="itemCount">0</span>
                    ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ
                </span>
                <div class="flex items-center gap-2">
                    <button onclick="cycleSort()" id="sortBtn" class="text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-primary transition"><i class="fas fa-sort"></i> ‡¶∏‡¶∞‡ßç‡¶ü</button>
                    <button onclick="toggleFilter()" id="filterBtn" class="text-sm font-medium text-gray-500 dark:text-gray-400"><i class="fas fa-filter"></i> ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö</button>
                </div>
            </h3>
            
            <input type="text" id="listSearch" oninput="renderHome()" class="input-field w-full p-3 mb-3 hidden transition-all duration-300" placeholder="üîç ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...">

            <div id="currentList" class="space-y-3 min-h-[100px]">
                <div class="text-center py-10 opacity-50">
                    <i class="fas fa-basket-shopping text-4xl mb-2 text-gray-300 dark:text-gray-600"></i>
                    <p class="text-gray-400 text-sm">‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶è‡¶ñ‡¶®‡ßã ‡¶ñ‡¶æ‡¶≤‡¶ø</p>
                </div>
            </div>
        </div>

        <div id="checkoutBar" class="fixed bottom-0 left-0 w-full bg-white dark:bg-dark-card p-4 border-t border-gray-100 dark:border-gray-700 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] hidden z-40 rounded-t-3xl backdrop-blur-lg bg-opacity-90 dark:bg-opacity-95">
            <div class="container mx-auto max-w-lg flex items-center gap-4">
                <div class="flex-1">
                    <p class="text-[10px] text-gray-500 dark:text-gray-400 font-bold uppercase tracking-wider">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤</p>
                    <p class="text-2xl font-bold text-primary dark:text-blue-400" id="footerTotal">‡ß≥ ‡ß¶</p>
                </div>
                <button onclick="confirmCheckout()" class="flex-1 bg-gradient-to-r from-primary to-secondary text-white font-bold py-3.5 rounded-xl shadow-lg shadow-primary/30 dark:shadow-none active:scale-95 transition flex justify-center items-center gap-2">
                    ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶∂‡ßá‡¶∑ <span class="text-sm" id="footerItemCount">(‡ß¶)</span> <i class="fas fa-check"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="view-calculator" class="page-section container mx-auto max-w-lg p-4 hidden">
        <h2 class="text-2xl font-bold dark:text-white mb-4">üßÆ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞</h2>
        <div class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-xl">
            <div class="text-right mb-4">
                <p id="calcHistory" class="text-gray-500 dark:text-gray-400 text-sm h-5"></p>
                <p id="calcDisplay" class="text-4xl font-extrabold dark:text-white h-12 truncate">0</p>
            </div>
            <div class="grid grid-cols-4 gap-3">
                <button onclick="calcClearAll()" class="calc-btn calc-misc text-red-500 dark:text-red-400">AC</button>
                <button onclick="calcDelete()" class="calc-btn calc-misc"><i class="fas fa-backspace"></i></button>
                <button onclick="calcInput('%')" class="calc-btn calc-misc">%</button>
                <button onclick="calcOperator('/')" class="calc-btn calc-operator">√∑</button>
                <button onclick="calcInput('7')" class="calc-btn calc-digit">‡ß≠</button>
                <button onclick="calcInput('8')" class="calc-btn calc-digit">‡ßÆ</button>
                <button onclick="calcInput('9')" class="calc-btn calc-digit">‡ßØ</button>
                <button onclick="calcOperator('*')" class="calc-btn calc-operator">√ó</button>
                <button onclick="calcInput('4')" class="calc-btn calc-digit">‡ß™</button>
                <button onclick="calcInput('5')" class="calc-btn calc-digit">‡ß´</button>
                <button onclick="calcInput('6')" class="calc-btn calc-digit">‡ß¨</button>
                <button onclick="calcOperator('-')" class="calc-btn calc-operator">-</button>
                <button onclick="calcInput('1')" class="calc-btn calc-digit">‡ßß</button>
                <button onclick="calcInput('2')" class="calc-btn calc-digit">‡ß®</button>
                <button onclick="calcInput('3')" class="calc-btn calc-digit">‡ß©</button>
                <button onclick="calcOperator('+')" class="calc-btn calc-operator">+</button>
                <button onclick="calcInput('0')" class="calc-btn calc-digit col-span-2">‡ß¶</button>
                <button onclick="calcInput('.')" class="calc-btn calc-digit">.</button>
                <button onclick="calcCalculate()" class="calc-btn calc-operator">=</button> 
            </div>
        </div>
    </div>
    
    <div id="view-notepad" class="page-section container mx-auto max-w-lg p-4 hidden">
        <h2 class="text-2xl font-bold dark:text-white mb-4">üìù ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶®‡ßã‡¶ü‡¶™‡ßç‡¶Ø‡¶æ‡¶°</h2>
        <div class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-xl mb-6">
            <textarea id="notepadInput" oninput="analyzeNoteLive()" class="input-field w-full h-32 p-3 resize-none font-medium dark:text-white" placeholder="‡¶∞‡ßÅ‡¶á ‡ß® ‡¶ï‡ßá‡¶ú‡¶ø&#10;‡¶≤‡¶æ‡¶≤ ‡¶∂‡¶æ‡¶ï ‡ßß ‡¶ï‡ßá‡¶ú‡¶ø&#10;‡¶°‡¶ø‡¶Æ ‡ßß ‡¶°‡¶ú‡¶®" rows="4"></textarea>
            <div id="analysisSummary" class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                <p>‚ö†Ô∏è ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶≤‡¶æ‡¶á‡¶® ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡•§ (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ [‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£] [‡¶è‡¶ï‡¶ï])</p>
                <p class="font-bold">‚ú® ‡¶Ö‡¶ü‡ßã‡¶™‡ßÅ‡¶∞‡¶£: <span id="mockCorrectionStatus" class="text-primary">‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º (‡¶¨‡¶æ‡¶®‡¶æ‡¶® ‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶® ‡¶Æ‡¶ï)</span></p>
            </div>
            <button onclick="saveNote()" class="w-full bg-secondary text-white font-bold py-3 rounded-xl hover:shadow-lg mt-4 active:scale-95 transition flex justify-center items-center gap-2">
                <i class="fas fa-save"></i> ‡¶®‡ßã‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
        </div>
        <div class="mb-28">
            <h3 class="font-bold text-gray-700 dark:text-gray-300 mb-3 flex items-center justify-between">
                <span>
                    <span class="bg-secondary/20 dark:bg-secondary/40 text-secondary dark:text-white w-6 h-6 flex items-center justify-center rounded-full text-xs inline-flex mr-2" id="noteCount">0</span>
                    ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶®‡ßã‡¶ü
                </span>
                <select id="noteMonthFilter" onchange="renderNotepad()" class="text-sm font-medium text-gray-500 dark:text-gray-400 bg-transparent outline-none border rounded-lg p-1 dark:border-gray-700">
                    <option value="all">‡¶∏‡¶¨ ‡¶Æ‡¶æ‡¶∏</option>
                </select>
            </h3>
            <div id="savedNotesContainer" class="space-y-3"></div>
        </div>
    </div>
    
    <div id="view-stats" class="page-section container mx-auto max-w-lg p-4 hidden">
        <h2 class="text-2xl font-bold dark:text-white mb-4">üìà ‡¶Æ‡¶æ‡¶∏ ‡¶∂‡ßá‡¶∑‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h2>
        <div class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-xl mb-6">
            <h3 class="text-lg font-bold mb-3 dark:text-white">‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£</h3>
            <div class="h-64">
                <canvas id="categoryChart"></canvas>
            </div>
            <div id="statsSummary" class="mt-4 space-y-1"></div>
        </div>
    </div>
    
    <div id="view-price-tracker" class="page-section container mx-auto max-w-lg p-4 hidden">
        <h2 class="text-2xl font-bold dark:text-white mb-4">üè∑Ô∏è ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶∏ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶∞</h2>
        <div class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-xl mb-6">
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßá‡¶®‡¶æ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ó‡ßÅ‡¶≤‡¶ø‡¶∞ ‡¶ó‡¶°‡¶º ‡¶¶‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶¶‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§</p>
            <div id="priceTrackerContainer" class="space-y-4"></div>
        </div>
    </div>

    <div id="view-wishlist" class="page-section container mx-auto max-w-lg p-4 hidden">
        <h2 class="text-2xl font-bold dark:text-white mb-4">üõí ‡¶™‡¶∞‡ßá ‡¶ï‡¶ø‡¶®‡¶¨</h2>
        <div id="wishlistContainer" class="space-y-3 pb-20"></div>
    </div>

    <div id="view-history" class="page-section container mx-auto max-w-lg p-4 hidden">
        <div class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm mb-4 sticky top-20 z-30">
            <input type="text" id="historySearch" oninput="renderHistory()" class="input-field w-full p-3 border-none outline-none dark:text-white" placeholder="üîç ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¨‡¶æ ‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...">
        </div>
        <div id="historyContainer" class="space-y-3 pb-20"></div>
    </div>

    <div id="view-history-detail" class="page-section container mx-auto max-w-lg p-4 hidden">
        <div id="historyDetailHeader" class="bg-white dark:bg-dark-card p-4 rounded-xl shadow-sm mb-4 sticky top-20 z-30"></div>
        <div id="historyDetailList" class="space-y-3 pb-20"></div>
    </div>

    <div id="walletModal" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="modal-content" id="walletModalContent">
            <h3 class="text-xl font-bold text-center mb-1 dark:text-white">‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü</h3>
            <p class="text-xs text-center text-gray-400 mb-6">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶ï‡ßá‡¶ü‡ßá ‡¶è‡¶ñ‡¶® ‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ü‡¶õ‡ßá?</p>
            <input type="number" id="walletInput" class="w-full text-center text-4xl font-bold p-4 border-b-2 border-primary focus:outline-none dark:bg-transparent dark:text-white mb-6" placeholder="0">
            <div class="grid grid-cols-3 gap-2 mb-6">
                <button onclick="setWallet(500)" class="quick-btn">‡ß≥ ‡ß´‡ß¶‡ß¶</button>
                <button onclick="setWallet(1000)" class="quick-btn">‡ß≥ ‡ßß‡ß¶‡ß¶‡ß¶</button>
                <button onclick="setWallet(2000)" class="quick-btn">‡ß≥ ‡ß®‡ß¶‡ß¶‡ß¶</button>
            </div>
            <button onclick="saveWallet()" class="w-full bg-primary text-white font-bold py-3 rounded-xl shadow-lg">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>
    
    <div id="iconModal" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="modal-content" id="iconModalContent">
            <h3 class="text-xl font-bold text-center mb-4 dark:text-white">‡¶Ü‡¶á‡¶ï‡¶® ‡¶¨‡¶æ‡¶õ‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <div id="iconGrid" class="grid grid-cols-6 gap-2 text-3xl max-h-64 overflow-y-auto p-2 bg-gray-50 dark:bg-gray-800 rounded-lg"></div>
            <button onclick="closeIconModal()" class="w-full bg-gray-200 dark:bg-gray-700 font-bold py-2 mt-4 rounded-xl">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="modal-content" id="editModalContent">
            <h3 class="text-xl font-bold text-center mb-4 dark:text-white">‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <input type="hidden" id="editItemId">
            <div class="space-y-4">
                <input type="text" id="editItemName" class="input-field w-full p-3" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
                <input type="text" id="editItemTags" class="input-field w-full p-3" placeholder="‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®">
                <div class="relative">
                    <input type="number" id="editUnitPrice" class="input-field w-full p-3 pl-8 font-bold text-primary" placeholder="‡¶¶‡¶æ‡¶Æ (‡ß≥)" oninput="calculateEditLive()">
                    <span class="absolute left-3 top-3.5 text-primary font-bold">‡ß≥</span>
                </div>
                <div class="flex shadow-md rounded-xl overflow-hidden">
                    <input type="number" id="editWeight" step="0.01" class="input-field rounded-none border-0 font-bold text-secondary focus:ring-0" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" oninput="calculateEditLive()">
                    <button id="editWeightUnit" onclick="cycleEditUnit()" class="input-group-btn">‡¶ï‡ßá‡¶ú‡¶ø</button>
                </div>
                <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-800 p-3 rounded-xl">
                    <span class="text-sm font-bold">‡¶Æ‡ßã‡¶ü:</span>
                    <span class="text-xl font-bold text-primary dark:text-blue-400" id="editLiveCost">‡ß≥ ‡ß¶</span>
                </div>
            </div>
            <button onclick="saveEditedItem()" class="w-full bg-primary text-white font-bold py-3 rounded-xl shadow-lg mt-4">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <div id="budgetModal" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="modal-content" id="budgetModalContent">
            <h3 class="text-xl font-bold text-center mb-1 dark:text-white">üí∞ ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡¶æ‡¶ú‡ßá‡¶ü ‡¶∏‡ßá‡¶ü</h3>
            <p class="text-xs text-center text-gray-400 mb-6">‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ñ‡¶∞‡¶ö ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?</p>
            <input type="number" id="budgetInput" class="w-full text-center text-4xl font-bold p-4 border-b-2 border-green-500 focus:outline-none dark:bg-transparent dark:text-white mb-6" placeholder="0">
            <button onclick="saveBudget()" class="w-full bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg">‡¶¨‡¶æ‡¶ú‡ßá‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button onclick="clearBudget()" class="w-full bg-transparent text-red-500 font-bold py-2 mt-2">‡¶¨‡¶æ‡¶ú‡ßá‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®</button>
        </div>
    </div>
    
    <div id="categoryModal" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="modal-content max-w-md" id="categoryModalContent">
            <h3 class="text-xl font-bold text-center mb-4 dark:text-white">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
            <div id="currentCategories" class="space-y-2 max-h-40 overflow-y-auto mb-4 p-2 border rounded-lg dark:border-gray-700"></div>
            <h4 class="text-sm font-bold dark:text-gray-300 mt-4 mb-2">‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®:</h4>
            <div class="flex gap-2">
                <input type="text" id="newCategoryName" class="input-field flex-1" placeholder="‡¶®‡¶æ‡¶Æ (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶á‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡ßç‡¶∏)">
                <input type="text" id="newCategoryIcon" class="input-field w-16 text-center" placeholder="‡¶Ü‡¶á‡¶ï‡¶®">
                <input type="color" id="newCategoryColor" value="#ff0000" class="w-10 h-10 rounded-lg cursor-pointer">
            </div>
            <button onclick="addNewCategory()" class="w-full bg-primary text-white font-bold py-3 rounded-xl shadow-lg mt-4">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button onclick="closeCategoryManager()" class="w-full bg-gray-200 dark:bg-gray-700 font-bold py-2 mt-4 rounded-xl">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>
    
    <div id="importModal" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="modal-content max-w-md" id="importModalContent">
            <h3 class="text-xl font-bold text-center mb-4 dark:text-white">‡¶°‡ßá‡¶ü‡¶æ ‡¶á‡¶Æ‡¶™‡ßã‡¶∞‡ßç‡¶ü</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ JSON ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</p>
            <textarea id="importJsonArea" class="w-full h-40 input-field font-mono text-sm resize-none" placeholder="JSON ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®..."></textarea>
            <button onclick="importData()" class="w-full bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg mt-4">‡¶á‡¶Æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button onclick="document.getElementById('importModal').classList.add('hidden')" class="w-full bg-gray-200 dark:bg-gray-700 font-bold py-2 mt-2 rounded-xl">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        </div>
    </div>
    
    <div id="notepadDetailModal" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="modal-content max-w-md" id="notepadDetailModalContent">
            <h3 class="text-xl font-bold text-center mb-4 dark:text-white" id="notepadDetailTitle"></h3>
            <div id="notepadItemList" class="space-y-3 max-h-64 overflow-y-auto p-2 border rounded-lg dark:border-gray-700 mb-4"></div>
            <p class="text-xs text-center text-gray-500 dark:text-gray-400 mb-4">üí° ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡ßá **"‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®"**-‡¶è ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
            <div class="flex gap-2">
                <button onclick="closeNotepadDetailModal()" class="flex-1 bg-gray-200 dark:bg-gray-700 font-bold py-3 rounded-xl">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button onclick="addNoteItemsToCart()" class="flex-1 bg-primary text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2">
                    <i class="fas fa-cart-plus"></i> ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>

    <div id="undoToast" class="fixed bottom-28 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-5 py-3 rounded-full shadow-xl flex items-center gap-4 z-50 hidden transition-all">
        <span class="text-sm">‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá</span>
        <button onclick="undoDelete()" class="text-yellow-400 font-bold text-sm uppercase">‡¶´‡¶ø‡¶∞‡¶ø‡ßü‡ßá ‡¶Ü‡¶®‡ßÅ‡¶®</button>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="modal-content" id="confirmModalContent">
            <h3 class="text-xl font-bold text-center mb-4 dark:text-white">üí∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá‡¶∞ ‡¶ö‡ßÇ‡ßú‡¶æ‡¶®‡ßç‡¶§ ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™</h3>
            <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl mb-4 space-y-2 font-bold">
                <div class="flex justify-between items-center text-lg text-gray-800 dark:text-gray-200">
                    <span>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤:</span> <span id="checkoutTotal">‡ß≥ ‡ß¶</span>
                </div>
                <div class="flex justify-between items-center text-gray-800 dark:text-gray-200">
                    <span>‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡¶¶‡¶æ‡¶∞‡¶ï‡ßá ‡¶¶‡¶ø‡¶≤‡ßá‡¶®:</span> <span id="checkoutGiven">‡ß≥ ‡ß¶</span>
                </div>
                <div class="h-px bg-gray-300 dark:bg-gray-700 my-1"></div>
                <div class="flex justify-between items-center text-xl pt-1" id="checkoutChangeRow">
                    <span class="text-lg font-bold">‡¶´‡ßá‡¶∞‡¶§ ‡¶™‡¶æ‡¶¨‡ßá‡¶®:</span> <span id="checkoutChange" class="font-extrabold">‡ß≥ ‡ß¶</span>
                </div>
            </div>
            <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ:</h4>
            <div id="checkoutItemList" class="max-h-32 overflow-y-auto space-y-1 p-2 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-inner"></div>
            <p class="text-xs text-center text-gray-500 dark:text-gray-400 mt-4 mb-4">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶è‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶æ‡¶ü‡¶æ ‡¶π‡¶¨‡ßá‡•§</p>
            <div class="flex gap-4">
                <button onclick="closeConfirmModal()" class="flex-1 bg-gray-200 dark:bg-gray-700 font-bold py-3 rounded-xl">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button onclick="performCheckout()" class="flex-1 bg-primary text-white font-bold py-3 rounded-xl">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL DATA & STATE MANAGEMENT ---
        let items = [];
        let wishlist = JSON.parse(localStorage.getItem('sb5_wishlist')) || [];
        let deletedItem = null, undoTimer = null;
        let weightUnit = 'KG'; // 'KG' or 'PCS'
        let wallet = parseFloat(localStorage.getItem('sb5_wallet')) || 0;
        let history = JSON.parse(localStorage.getItem('sb5_history')) || [];
        let notes = JSON.parse(localStorage.getItem('sb5_notes')) || [];
        let userName = localStorage.getItem('sb5_user') || '‡¶¨‡¶®‡ßç‡¶ß‡ßÅ';
        let isDarkMode = localStorage.getItem('sb5_theme') === 'dark';
        let selectedIcon = localStorage.getItem('sb5_default_icon') || 'üõí';
        let priceMemory = JSON.parse(localStorage.getItem('sb5_price_memory')) || {};
        let currentSort = 'default';
        let monthlyBudget = parseFloat(localStorage.getItem('sb5_budget')) || 0;
        
        let appCategories = JSON.parse(localStorage.getItem('sb5_categories')) || {
            '‡¶Æ‡¶æ‡¶õ/‡¶Æ‡¶æ‡¶Ç‡¶∏': { icon: 'üçó', color: '#ff6384' },
            '‡¶∂‡¶æ‡¶ï‡¶∏‡¶¨‡¶ú‡¶ø': { icon: 'ü•¶', color: '#36a2eb' },
            '‡¶Æ‡ßÅ‡¶¶‡¶ø': { icon: 'üßÇ', color: '#ff9f40' },
            '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø': { icon: 'üõçÔ∏è', color: '#9966ff' }
        };
        
        // Calculator State
        let calcCurrentInput = '0';
        let calcExpression = '';
        let calcResultReady = false; 

        // Current view
        let currentPage = 'home';
        let currentParsedNoteItems = [];

        // --- CONSTANTS & UTILS ---
        const emojiIcons = ['üõí', 'üìù', 'üìå', 'üçé', 'ü•ï', 'ü•©', 'üçö', 'ü•õ', 'üß∫', 'üßº', 'üíä', 'üîã', 'üìö', '‚öΩ', 'üîë', 'üè†', 'üéÅ', 'üéÇ', 'üéà', 'üéâ', 'üíª', 'üöó', 'üíä', 'üëï', 'üë†', 'üç∫', '‚òï', 'üç´', 'üçï', 'üì∫', 'üì±', 'üî®', 'üî©', 'üå±', '‚òÄÔ∏è', 'üíß', 'üå°Ô∏è', 'üí°'];
        const banglaDigits = ['‡ß¶', '‡ßß', '‡ß®', '‡ß©', '‡ß™', '‡ß´', '‡ß¨', '‡ß≠', '‡ßÆ', '‡ßØ'];
        const toBn = (num) => {
            const numStr = num.toFixed(0).toLocaleString('en-US'); 
            return numStr.split('').map(c => banglaDigits[c] || c).join('');
        };
        const formatBnDate = (isoDate) => {
            const date = new Date(isoDate);
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true };
            return date.toLocaleDateString('bn-BD', options);
        };
        const parseBnFloat = (str) => {
            let numStr = str.split('').map(c => banglaDigits.indexOf(c) > -1 ? banglaDigits.indexOf(c) : c).join('');
            return parseFloat(numStr.replace(/,/g, '')) || 0;
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            if(isDarkMode) document.documentElement.classList.add('dark');
            document.getElementById('themeIcon').className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
            
            const savedCart = localStorage.getItem('sb5_cart');
            if(savedCart) items = JSON.parse(savedCart);
            if(wallet === 0) openWalletModal();
            
            document.getElementById('selectedIcon').innerText = selectedIcon;
            
            updateDateDisplay();
            updateCategoryDropdown();
            renderHome();
            renderSuggestions();
            populateIconModal();
            updateBudgetDisplay();
            populateNoteMonthFilter();
            
            showPage(currentPage);
        };
        
        // --- CATEGORY MANAGER ---
        function updateCategoryDropdown() {
            const selectEl = document.getElementById('itemCategory');
            selectEl.innerHTML = '';
            
            Object.keys(appCategories).forEach(catName => {
                const option = document.createElement('option');
                option.value = catName;
                option.textContent = `${appCategories[catName].icon} ${catName}`;
                selectEl.appendChild(option);
            });
            renderSuggestions();
        }
        
        function openCategoryManager() {
            renderCategoryList();
            document.getElementById('categoryModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('categoryModalContent').classList.remove('opacity-0', 'scale-95'), 10);
        }
        
        function closeCategoryManager() {
            document.getElementById('categoryModal').classList.add('hidden');
            document.getElementById('categoryModalContent').classList.add('opacity-0', 'scale-95');
        }

        function renderCategoryList() {
            const container = document.getElementById('currentCategories');
            container.innerHTML = '';
            Object.keys(appCategories).forEach(catName => {
                const cat = appCategories[catName];
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 rounded-lg bg-gray-50 dark:bg-gray-700';
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-xl" style="color:${cat.color}">${cat.icon}</span>
                        <span class="font-medium dark:text-white">${catName}</span>
                    </div>
                    <button onclick="deleteCategory('${catName}')" class="text-red-500 hover:text-red-700 text-sm"><i class="fas fa-trash-alt"></i></button>
                `;
                container.appendChild(div);
            });
        }
        
        function addNewCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            const icon = document.getElementById('newCategoryIcon').value.trim() || '‚ùì';
            const color = document.getElementById('newCategoryColor').value;
            if (name && !appCategories[name]) {
                appCategories[name] = { icon, color };
                localStorage.setItem('sb5_categories', JSON.stringify(appCategories));
                updateCategoryDropdown();
                renderCategoryList();
                document.getElementById('newCategoryName').value = '';
                document.getElementById('newCategoryIcon').value = '';
            }
        }
        
        function deleteCategory(catName) {
            if(Object.keys(appCategories).length <= 1) {
                console.error("‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§");
                return;
            }
            if(window.confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ${catName} ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶á ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶∞ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ó‡ßÅ‡¶≤‡¶ø '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø'-‡¶§‡ßá ‡¶ö‡¶≤‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§`)) {
                delete appCategories[catName];
                localStorage.setItem('sb5_categories', JSON.stringify(appCategories));
                updateCategoryDropdown();
                renderCategoryList();
            }
        }

        // --- CORE LOGIC ---
        function quickWeightChange(amount) {
            const weightInput = document.getElementById('weight');
            let current = parseFloat(weightInput.value) || 0;
            current += amount;
            weightInput.value = current.toFixed(2);
            calculateLive();
        }
        
        function clearInput(id) {
            document.getElementById(id).value = '';
            if(id === 'itemName') calculateLive();
        }
        
        function addItem() {
            const name = document.getElementById('itemName').value.trim();
            const tags = document.getElementById('itemTags').value.trim();
            const cat = document.getElementById('itemCategory').value;
            const p = parseFloat(document.getElementById('unitPrice').value);
            const w = parseFloat(document.getElementById('weight').value);
            const icon = document.getElementById('selectedIcon').innerText;
            const given = parseFloat(document.getElementById('givenAmount').value) || 0;

            let isValid = validateInput('itemName') & validateInput('unitPrice') & validateInput('weight');
            if(!isValid) { navigator.vibrate?.(100); return; }

            const cost = Math.round(p * w);
            
            items.unshift({
                id: Date.now(),
                name, cat, icon, p, w, cost, given, unit: weightUnit,
                change: given > 0 ? given - cost : null,
                tags: tags.split(/[\s,]+/).filter(tag => tag.startsWith('#') || tag.length > 0),
                isPinned: false
            });

            priceMemory[name] = p;
            localStorage.setItem('sb5_price_memory', JSON.stringify(priceMemory));
            
            document.getElementById('itemName').value = '';
            document.getElementById('unitPrice').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('givenAmount').value = '';
            document.getElementById('itemTags').value = '';
            document.getElementById('selectedIcon').innerText = localStorage.getItem('sb5_default_icon') || 'üõí';
            
            calculateLive();
            saveAndRender();
            
            document.getElementById('currentList').scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('itemName').focus();
            navigator.vibrate?.(50);
        }
        
        // --- LIST RENDERING ---
        function cycleSort() {
            if (currentSort === 'default') {
                currentSort = 'name-asc';
                document.getElementById('sortBtn').innerHTML = '<i class="fas fa-sort-alpha-down"></i> ‡¶®‡¶æ‡¶Æ A-Z';
            } else if (currentSort === 'name-asc') {
                currentSort = 'cost-desc';
                document.getElementById('sortBtn').innerHTML = '<i class="fas fa-sort-amount-down-alt"></i> ‡¶¶‡¶æ‡¶Æ ‡¶¨‡ßá‡¶∂‡¶ø';
            } else {
                currentSort = 'default';
                document.getElementById('sortBtn').innerHTML = '<i class="fas fa-sort"></i> ‡¶∏‡¶∞‡ßç‡¶ü';
            }
            renderHome();
        }

        function renderHome() {
            const listSearchTerm = document.getElementById('listSearch').value.toLowerCase();
            const pinnedItems = items.filter(item => item.isPinned);
            let unpinnedItems = items.filter(item => !item.isPinned);
            unpinnedItems = unpinnedItems.filter(item => item.name.toLowerCase().includes(listSearchTerm) || (item.tags && item.tags.some(t => t.toLowerCase().includes(listSearchTerm))));

            if (currentSort === 'name-asc') {
                unpinnedItems.sort((a, b) => a.name.localeCompare(b.name, 'bn'));
            } else if (currentSort === 'cost-desc') {
                unpinnedItems.sort((a, b) => b.cost - a.cost);
            }
            
            const totalItems = [...pinnedItems, ...unpinnedItems];
            const total = totalItems.reduce((a, b) => a + b.cost, 0);
            const bal = wallet - total;

            document.getElementById('menuUserName').innerText = userName;
            document.getElementById('currentBalance').innerText = '‡ß≥ ' + toBn(bal);
            document.getElementById('todaySpent').innerText = '‡ß≥ ' + toBn(total);
            document.getElementById('footerTotal').innerText = '‡ß≥ ' + toBn(total);
            document.getElementById('itemCount').innerText = toBn(items.length);
            document.getElementById('footerItemCount').innerText = '(' + toBn(items.length) + ')';

            const card = document.querySelector('.balance-card');
            card.classList.remove('from-red-600', 'to-pink-600', 'from-primary', 'to-secondary');
            card.classList.add(bal < 0 ? 'from-red-600' : 'from-primary', bal < 0 ? 'to-pink-600' : 'to-secondary');
            
            updateBudgetDisplay(total);

            const listEl = document.getElementById('currentList');
            const footer = document.getElementById('checkoutBar');
            listEl.innerHTML = '';

            if(items.length === 0) {
                listEl.innerHTML = `<div class="text-center py-10 opacity-50 fade-in"><i class="fas fa-basket-shopping text-4xl mb-2 text-gray-300 dark:text-gray-600"></i><p class="text-gray-400 text-sm">‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶è‡¶ñ‡¶®‡ßã ‡¶ñ‡¶æ‡¶≤‡¶ø</p></div>`;
                footer.classList.add('hidden');
            } else {
                footer.classList.remove('hidden');
                totalItems.forEach(item => {
                    const catInfo = appCategories[item.cat] || appCategories['‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø'];
                    const catColor = catInfo.color;
                    
                    let changeHtml = '';
                    if (item.given > 0) {
                        const isPlus = item.change >= 0;
                        changeHtml = `<span class="text-[10px] ${isPlus ? 'text-green-600 bg-green-50' : 'text-red-500 bg-red-50'} px-1 rounded ml-1 border dark:bg-transparent dark:border-gray-600">‡¶´‡ßá‡¶∞‡¶§: ${toBn(Math.abs(item.change))}</span>`;
                        changeHtml += `<span class="text-[10px] text-gray-500 bg-gray-100 px-1 rounded ml-1 border dark:bg-transparent dark:border-gray-600">‡¶¶‡¶ø‡¶≤‡ßá‡¶®: ${toBn(item.given)}</span>`;
                    }
                    
                    let tagsHtml = item.tags && item.tags.length > 0 ? item.tags.map(tag => `<span class="tag-pill mr-1">${tag}</span>`).join('') : '';
                    const pinClass = item.isPinned ? 'text-yellow-500' : 'text-gray-300';

                    const div = document.createElement('div');
                    div.className = `bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md border-l-4 transition hover:shadow-xl fade-in relative`;
                    div.style.borderLeftColor = catColor;
                    
                    div.innerHTML = `
                        <button onclick="togglePin(${item.id})" class="absolute top-2 right-2 text-sm ${pinClass} hover:text-yellow-600 transition"><i class="fas fa-thumbtack"></i></button>
                        <div class="flex items-center gap-3 w-4/5">
                            <div class="w-10 h-10 rounded-full text-xl flex items-center justify-center bg-gray-100 dark:bg-gray-700">${item.icon}</div>
                            <div class="truncate">
                                <p class="font-bold text-gray-800 dark:text-gray-200 leading-tight">${item.name} ${changeHtml}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">${toBn(item.w)} ${item.unit} x ‡ß≥${toBn(item.p)}</p>
                                <div class="mt-1">${tagsHtml}</div>
                            </div>
                        </div>
                        <div class="absolute right-4 bottom-4 flex items-center gap-2">
                            <span class="font-bold text-lg text-gray-700 dark:text-gray-300">‡ß≥ ${toBn(item.cost)}</span>
                            <div class="flex gap-1">
                                <button onclick="duplicateItem(${item.id})" title="Duplicate" class="w-7 h-7 rounded-full text-gray-400 hover:bg-blue-50 hover:text-blue-600 transition"><i class="fas fa-copy text-xs"></i></button>
                                <button onclick="openEditModal(${item.id})" title="Edit" class="w-7 h-7 rounded-full text-gray-400 hover:bg-yellow-50 hover:text-yellow-600 transition"><i class="fas fa-edit text-xs"></i></button>
                                <button onclick="moveToWishlist(${item.id})" title="Buy Later" class="w-7 h-7 rounded-full text-gray-400 hover:bg-pink-50 hover:text-pink-600 transition"><i class="fas fa-heart text-xs"></i></button>
                                <button onclick="deleteItem(${item.id})" title="Delete" class="w-7 h-7 rounded-full text-gray-400 hover:bg-red-50 hover:text-red-500 transition"><i class="fas fa-times text-xs"></i></button>
                            </div>
                        </div>
                    `;
                    listEl.appendChild(div);
                });
            }
        }
        
        function togglePin(id) {
            const item = items.find(i => i.id === id);
            if(item) {
                item.isPinned = !item.isPinned;
                saveAndRender();
            }
        }

        function duplicateItem(id) {
            const originalItem = items.find(i => i.id === id);
            if (originalItem) {
                const duplicated = { ...originalItem, id: Date.now(), isPinned: false };
                items.unshift(duplicated);
                saveAndRender();
            }
        }
        
        // --- BUDGET TRACKER ---
        function updateBudgetDisplay(currentTotal = items.reduce((a, b) => a + b.cost, 0)) {
            const barContainer = document.getElementById('budgetBarContainer');
            if (monthlyBudget > 0) {
                barContainer.classList.remove('hidden');
                document.getElementById('budgetAmountText').innerText = '‡ß≥ ' + toBn(monthlyBudget);
                
                const spentPercentage = (currentTotal / monthlyBudget) * 100;
                const remaining = monthlyBudget - currentTotal;
                
                const progressBar = document.getElementById('budgetProgressBar');
                progressBar.style.width = `${Math.min(spentPercentage, 100)}%`;
                
                progressBar.classList.remove('bg-yellow-300', 'bg-red-500');
                if (spentPercentage > 90) {
                    progressBar.classList.add('bg-red-500');
                    document.getElementById('budgetRemainingText').innerText = '‚ö†Ô∏è ‡¶¨‡¶æ‡¶ú‡ßá‡¶ü ‡¶∂‡ßá‡¶∑‡ßá‡¶∞ ‡¶™‡¶•‡ßá';
                } else if (spentPercentage > 60) {
                    progressBar.classList.add('bg-yellow-300');
                    document.getElementById('budgetRemainingText').innerText = `‡¶Ü‡¶∞ ‡¶Ü‡¶õ‡ßá: ‡ß≥ ${toBn(remaining)}`;
                } else {
                    progressBar.classList.add('bg-yellow-300');
                    document.getElementById('budgetRemainingText').innerText = `‡¶Ü‡¶∞ ‡¶Ü‡¶õ‡ßá: ‡ß≥ ${toBn(remaining)}`;
                }
            } else {
                barContainer.classList.add('hidden');
            }
        }

        function openBudgetModal() {
            document.getElementById('budgetModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('budgetModalContent').classList.remove('opacity-0', 'scale-95'), 10);
            if(monthlyBudget > 0) document.getElementById('budgetInput').value = monthlyBudget;
        }

        function saveBudget() {
            const b = parseFloat(document.getElementById('budgetInput').value);
            if(b >= 0) { 
                monthlyBudget = b; 
                localStorage.setItem('sb5_budget', monthlyBudget); 
                document.getElementById('budgetModal').classList.add('hidden'); 
                updateBudgetDisplay();
                renderHome(); 
            }
        }
        
        function clearBudget() {
            monthlyBudget = 0;
            localStorage.removeItem('sb5_budget');
            document.getElementById('budgetModal').classList.add('hidden'); 
            updateBudgetDisplay();
            renderHome(); 
        }

        // --- CALCULATOR ---
        function calcInput(val) {
             if (calcResultReady) {
                calcCurrentInput = (val === '.') ? '0.' : val;
                calcExpression = '';
                calcResultReady = false;
            } else if (calcCurrentInput === '0' && val !== '.') {
                calcCurrentInput = val;
            } else {
                if (val === '.' && calcCurrentInput.includes('.')) return;
                calcCurrentInput += val;
            }
            calcLiveCalculate(); 
            calcDisplay.innerText = toBn(parseBnFloat(calcCurrentInput));
        }

        function calcOperator(op) {
            if (calcCurrentInput === '0' && calcExpression === '') return;
            if (calcExpression !== '' && ['+', '-', '*', '/'].includes(calcExpression.slice(-1))) {
                calcExpression = calcExpression.slice(0, -1) + op;
            } else {
                calcExpression += calcCurrentInput + op;
            }
            calcCurrentInput = '0';
            calcDisplay.innerText = '‡ß¶';
            calcResultReady = false;
            calcLiveCalculate();
        }

        function calcClearAll() {
            calcCurrentInput = '0';
            calcExpression = '';
            calcDisplay.innerText = '‡ß¶';
            calcHistory.innerText = '';
            calcResultReady = false;
        }

        function calcDelete() {
            if (calcCurrentInput !== '0') {
                calcCurrentInput = calcCurrentInput.slice(0, -1);
                if (calcCurrentInput === '') calcCurrentInput = '0';
            } else if (calcExpression !== '') {
                calcExpression = calcExpression.slice(0, -1);
                const match = calcExpression.match(/(\d+\.?\d*)$/);
                 if (match) {
                    calcCurrentInput = match[1];
                    calcExpression = calcExpression.slice(0, -match[1].length);
                }
            }
            calcLiveCalculate();
            calcDisplay.innerText = toBn(parseBnFloat(calcCurrentInput));
            calcHistory.innerText = calcExpression.replace(/\*/g, '√ó').replace(/\//g, '√∑') + (calcCurrentInput !== '0' ? calcCurrentInput : '');
        }

        function calcLiveCalculate() {
            try {
                let expression = (calcExpression + calcCurrentInput).replace(/√ó/g, '*').replace(/√∑/g, '/');
                if (expression.endsWith('+') || expression.endsWith('-') || expression.endsWith('*') || expression.endsWith('/')) {
                    expression = expression.slice(0, -1);
                }
                if (expression.length === 0) {
                     calcHistory.innerText = ''; 
                     return;
                }
                const result = eval(expression);
                calcHistory.innerText = (calcExpression + calcCurrentInput).replace(/\*/g, '√ó').replace(/\//g, '√∑') + ' = ' + toBn(result);
            } catch (e) {
                calcHistory.innerText = (calcExpression + calcCurrentInput).replace(/\*/g, '√ó').replace(/\//g, '√∑');
            }
        }
        
        function calcCalculate() {
             try {
                let expression = (calcExpression + calcCurrentInput).replace(/√ó/g, '*').replace(/√∑/g, '/');
                if (expression.length === 0) return;
                const result = eval(expression);
                calcHistory.innerText = (calcExpression + calcCurrentInput).replace(/\*/g, '√ó').replace(/\//g, '√∑') + ' =';
                calcCurrentInput = result.toString();
                calcExpression = '';
                calcDisplay.innerText = toBn(result);
                calcResultReady = true;
            } catch (e) {
                calcDisplay.innerText = '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø';
                calcCurrentInput = '0';
                calcExpression = '';
            }
        }
        
        // --- NOTEPAD ---
        function findCategoryAndIcon(itemName) {
            const nameLower = itemName.toLowerCase();
            let bestCat = '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø';
            let bestIcon = appCategories['‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø'].icon;
            for (const catName in suggestions) {
                const catSuggestions = suggestions[catName];
                for (const item of catSuggestions) {
                    if (nameLower.includes(item.name.toLowerCase())) {
                        return { cat: catName, icon: item.icon };
                    }
                }
            }
             for (const catName in appCategories) {
                if (nameLower.includes(catName.toLowerCase())) {
                    return { cat: catName, icon: appCategories[catName].icon };
                }
            }
            return { cat: bestCat, icon: bestIcon };
        }

        function mockAutoCorrect(text) {
            const corrections = { '‡¶∞‡ßÅ‡¶á': '‡¶∞‡ßÅ‡¶á ‡¶Æ‡¶æ‡¶õ', '‡¶∂‡¶æ‡¶ï': '‡¶≤‡¶æ‡¶≤ ‡¶∂‡¶æ‡¶ï', '‡¶°‡¶ú‡¶®': '‡¶°‡¶ø‡¶Æ', '‡¶Ü‡¶≤‡ßÅ': '‡¶Ü‡¶≤‡ßÅ', '‡¶ï‡ßá‡¶ú‡¶ø': '‡¶ï‡ßá‡¶ú‡¶ø', '‡¶™‡¶ø‡¶∏': '‡¶™‡¶ø‡¶∏' };
            let corrected = text;
            for (const [wrong, right] of Object.entries(corrections)) {
                const regex = new RegExp(`\\b${wrong}\\b`, 'g');
                corrected = corrected.replace(regex, right);
            }
            return corrected;
        }

        function analyzeNoteLive() {
            const rawText = document.getElementById('notepadInput').value;
            const lines = rawText.split('\n').filter(line => line.trim() !== '');
            currentParsedNoteItems = [];
            
            lines.forEach((line, index) => {
                let name = line.trim();
                let quantity = 1;
                let unit = 'PCS';
                let isManual = false; 
                
                const correctedName = mockAutoCorrect(name);
                name = correctedName;
                if (name.includes('‡¶≤‡¶æ‡¶≤ ‡¶∂‡¶æ‡¶ï')) isManual = true;

                const match = name.match(/(\d+\.?\d*)\s*(‡¶ï‡ßá‡¶ú‡¶ø|‡¶™‡¶ø‡¶∏|‡¶°‡¶ú‡¶®|‡¶≤‡¶ø‡¶ü‡¶æ‡¶∞|gm)?$/i);
                if (match) {
                    quantity = parseFloat(match[1]) || 1;
                    unit = (match[2] || 'PCS').toUpperCase().replace('GM', 'KG'); 
                    name = name.substring(0, match.index).trim();
                }

                const unitMap = { '‡¶ï‡ßá‡¶ú‡¶ø': 'KG', '‡¶™‡¶ø‡¶∏': 'PCS', '‡¶°‡¶ú‡¶®': 'PCS', '‡¶≤‡¶ø‡¶ü‡¶æ‡¶∞': 'KG', 'GM': 'KG', 'KG': 'KG', 'PCS': 'PCS' };
                unit = unitMap[unit] || 'PCS';
                
                const { cat, icon } = findCategoryAndIcon(name);

                currentParsedNoteItems.push({
                    id: index,
                    raw: line,
                    name: name || '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ',
                    w: quantity,
                    unit: unit,
                    cat: cat,
                    icon: icon,
                    p: priceMemory[name] || 0, 
                    cost: Math.round(quantity * (priceMemory[name] || 0)), 
                    isManual: isManual
                });
            });
            if (!document.getElementById('notepadDetailModal').classList.contains('hidden')) {
                 renderNotepadDetailModal(currentParsedNoteItems);
            }
        }
        
        function saveNote() {
            const rawText = document.getElementById('notepadInput').value.trim();
            if (!rawText) return;
            analyzeNoteLive(); 
            notes.unshift({ id: Date.now(), date: new Date().toISOString(), content: rawText, items: currentParsedNoteItems });
            localStorage.setItem('sb5_notes', JSON.stringify(notes));
            document.getElementById('notepadInput').value = ''; 
            renderNotepad();
            openNotepadDetailModal(notes[0].id);
            navigator.vibrate?.(50);
        }

        function renderNotepad() {
            populateNoteMonthFilter();
            const filterMonth = document.getElementById('noteMonthFilter').value;
            const container = document.getElementById('savedNotesContainer');
            container.innerHTML = '';
            
            const filteredNotes = notes.filter(note => {
                if (filterMonth === 'all') return true;
                const noteDate = new Date(note.date);
                const monthYear = `${noteDate.getFullYear()}-${noteDate.getMonth()}`;
                return monthYear === filterMonth;
            });
            
            document.getElementById('noteCount').innerText = toBn(filteredNotes.length);

            if (filteredNotes.length === 0) {
                 container.innerHTML = `<div class="text-center py-10 opacity-50 fade-in"><i class="fas fa-list-alt text-4xl mb-2 text-gray-300 dark:text-gray-600"></i><p class="text-gray-400 text-sm">‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡ßã‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§</p></div>`;
                 return;
            }

            filteredNotes.forEach(note => {
                const dateText = formatBnDate(note.date);
                const itemsSummary = note.items.map(i => `${i.icon} ${i.name} (${toBn(i.w)} ${i.unit})`).join(', ').substring(0, 100);
                const div = document.createElement('div');
                div.className = 'note-item-analyzed fade-in';
                div.onclick = () => openNotepadDetailModal(note.id);
                div.innerHTML = `
                    <div class="w-11/12 truncate">
                        <p class="font-bold dark:text-white">${dateText.split(',')[0]} <span class="text-xs text-gray-500 font-normal">(${dateText.split(',')[1].trim()})</span></p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1 truncate">${itemsSummary}</p>
                    </div>
                    <button onclick="event.stopPropagation(); deleteNote(${note.id})" class="text-red-500 hover:text-red-700 text-sm p-1 ml-2"><i class="fas fa-trash-alt"></i></button>
                `;
                container.appendChild(div);
            });
        }
        
        function deleteNote(id) {
             if(window.confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶è‡¶á ‡¶®‡ßã‡¶ü‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
                notes = notes.filter(n => n.id !== id);
                localStorage.setItem('sb5_notes', JSON.stringify(notes));
                renderNotepad();
            }
        }
        
        function populateNoteMonthFilter() {
            const selectEl = document.getElementById('noteMonthFilter');
            const currentFilter = selectEl.value;
            selectEl.innerHTML = '<option value="all">‡¶∏‡¶¨ ‡¶Æ‡¶æ‡¶∏</option>';
            const months = {};
            notes.forEach(note => {
                const date = new Date(note.date);
                const monthYearKey = `${date.getFullYear()}-${date.getMonth()}`;
                const monthName = date.toLocaleDateString('bn-BD', { year: 'numeric', month: 'long' });
                months[monthYearKey] = monthName;
            });
            const sortedMonths = Object.keys(months).sort((a, b) => new Date(b.replace('-', '/1/')) - new Date(a.replace('-', '/1/')));
            sortedMonths.forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = months[key];
                if (key === currentFilter) option.selected = true;
                selectEl.appendChild(option);
            });
        }
        
        function openNotepadDetailModal(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;
            currentParsedNoteItems = note.items;
            document.getElementById('notepadDetailTitle').innerText = formatBnDate(note.date).split(',')[0] + ' ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ';
            renderNotepadDetailModal(currentParsedNoteItems);
            document.getElementById('notepadDetailModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('notepadDetailModalContent').classList.remove('opacity-0', 'scale-95'), 10);
        }
        
        function renderNotepadDetailModal(items) {
            const listEl = document.getElementById('notepadItemList');
            listEl.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 rounded-lg bg-gray-50 dark:bg-gray-800';
                if (item.isManual) {
                     div.classList.add('note-item-manual');
                     div.classList.remove('bg-gray-50');
                     div.classList.add('bg-red-50', 'dark:bg-red-900/10');
                } else {
                     div.classList.remove('note-item-manual');
                }
                const priceText = item.p > 0 ? `‡ß≥ ${toBn(item.p)}` : '‚ùì‡¶¶‡¶æ‡¶Æ ‡¶®‡ßá‡¶á';
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-xl">${item.icon}</span>
                        <div class="truncate">
                            <p class="font-bold dark:text-white leading-tight">${item.name} ${item.isManual ? '<span class="text-red-500 text-xs font-normal">(‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ)</span>' : ''}</p>
                            <p class="text-xs text-gray-500">${toBn(item.w)} ${item.unit} @ ${priceText}</p>
                        </div>
                    </div>
                `;
                listEl.appendChild(div);
            });
        }
        
        function closeNotepadDetailModal() {
            document.getElementById('notepadDetailModal').classList.add('hidden');
            document.getElementById('notepadDetailModalContent').classList.add('opacity-0', 'scale-95');
        }
        
        function addNoteItemsToCart() {
            currentParsedNoteItems.forEach(parsedItem => {
                if (parsedItem.name && parsedItem.name !== '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ') {
                    const defaultCategory = '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø';
                    const defaultIcon = appCategories[defaultCategory] ? appCategories[defaultCategory].icon : 'üõçÔ∏è';
                    items.unshift({
                        id: Date.now() + Math.random(),
                        name: parsedItem.name,
                        cat: defaultCategory,
                        icon: defaultIcon,
                        p: parsedItem.p,
                        w: parsedItem.w,
                        cost: Math.round(parsedItem.w * parsedItem.p),
                        given: 0,
                        unit: parsedItem.unit,
                        change: null,
                        tags: [],
                        isPinned: false
                    });
                }
            });
            saveAndRender();
            closeNotepadDetailModal();
            showPage('home');
        }

        // --- UTILS ---
        function updateDateDisplay() {
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            const today = new Date().toLocaleDateString('bn-BD', options);
            document.getElementById('currentDateDisplay').innerText = `‡¶Ü‡¶ú: ${today}`;
        }
        function autoSuggestPrice() {
            const name = document.getElementById('itemName').value.trim();
            const memoryEl = document.getElementById('priceMemory');
            if (name && priceMemory[name]) {
                const lastPrice = priceMemory[name];
                memoryEl.innerHTML = `‡¶ó‡¶§‡¶¨‡¶æ‡¶∞ ‡¶ï‡ßá‡¶®‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡¶ø‡¶≤: ‡ß≥ ${toBn(lastPrice)} (‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®)`;
                memoryEl.classList.remove('hidden');
                memoryEl.dataset.price = lastPrice;
            } else {
                memoryEl.classList.add('hidden');
            }
        }
        function applySuggestedPrice() {
            const price = document.getElementById('priceMemory').dataset.price;
            document.getElementById('unitPrice').value = price;
            calculateLive();
        }
        function renderSuggestions() {
            const cat = document.getElementById('itemCategory').value;
            const container = document.getElementById('suggestionContainer');
            const list = suggestions[cat] || [];
            container.innerHTML = list.map(item => `
                <button onclick="fillForm('${item.name}', '${item.icon}')" class="sugg-chip">
                    ${item.icon} ${item.name}
                </button>
            `).join('');
            container.classList.remove('fade-in');
            void container.offsetWidth; 
            container.classList.add('fade-in');
        }
        function fillForm(name, icon) {
            document.getElementById('itemName').value = name;
            document.getElementById('selectedIcon').innerText = icon;
            document.getElementById('unitPrice').value = ''; 
            document.getElementById('weight').focus();
            autoSuggestPrice();
            navigator.vibrate?.(20);
        }
        function cycleWeightUnit() {
            weightUnit = weightUnit === 'KG' ? 'PCS' : 'KG';
            document.getElementById('weightUnit').innerText = weightUnit === 'KG' ? '‡¶ï‡ßá‡¶ú‡¶ø' : '‡¶™‡¶ø‡¶∏';
            calculateLive();
        }
        
        function calculateLive() {
            const p = parseFloat(document.getElementById('unitPrice').value) || 0;
            const w = parseFloat(document.getElementById('weight').value) || 0;
            const cost = Math.round(p * w);
            document.getElementById('liveCost').innerText = '‡ß≥ ' + toBn(cost);

            const given = parseFloat(document.getElementById('givenAmount').value) || 0;
            const badge = document.getElementById('changeBadge');
            if (given > 0 || cost > 0) {
                badge.classList.remove('hidden');
                const diff = given - cost;
                document.getElementById('changeAmount').innerText = '‡ß≥ ' + toBn(Math.abs(diff));
                if (diff >= 0) {
                    badge.className = 'px-4 py-2 rounded-xl text-center min-w-[100px] transition-all duration-300 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 border border-green-200 dark:border-green-800';
                    document.getElementById('changeLabel').innerText = '‡¶´‡ßá‡¶∞‡¶§ ‡¶™‡¶æ‡¶¨‡ßá‡¶®';
                } else {
                    badge.className = 'px-4 py-2 rounded-xl text-center min-w-[100px] transition-all duration-300 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 border border-red-200 dark:border-red-800';
                    document.getElementById('changeLabel').innerText = '‡¶Ü‡¶∞‡ßã ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá';
                }
            } else {
                badge.classList.add('hidden');
            }
        }
        
        function validateInput(id) {
            const input = document.getElementById(id);
            if (!input.value) {
                input.classList.add('input-error');
                return false;
            }
            input.classList.remove('input-error');
            return true;
        }
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${pageId}`).classList.remove('hidden');
            currentPage = pageId;
            const backBtn = document.getElementById('globalBackBtn');
            backBtn.classList.toggle('hidden', pageId === 'home');
            const titleMap = {
                'home': '<i class="fas fa-cart-shopping mr-1 text-white"></i>‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞',
                'wishlist': '‡¶™‡¶∞‡ßá ‡¶ï‡¶ø‡¶®‡¶¨ (Wishlist)',
                'history': '‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨',
                'calculator': '‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞',
                'stats': '‡¶Æ‡¶æ‡¶∏ ‡¶∂‡ßá‡¶∑‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü',
                'price-tracker': '‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶∏ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶∞',
                'notepad': '‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶®‡ßã‡¶ü‡¶™‡ßç‡¶Ø‡¶æ‡¶°'
            };
            document.getElementById('pageTitle').innerHTML = titleMap[pageId] || '‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§';
        }
        function goBack() {
            if (currentPage === 'history-detail') {
                showPage('history');
                renderHistory();
            } else if (currentPage !== 'home') {
                showPage('home');
                renderHome();
            }
        }
        function goToHistoryPage() { toggleMenu(); showPage('history'); renderHistory(); }
        function goToWishlistPage() { toggleMenu(); showPage('wishlist'); renderWishlist(); }
        function renderHistory() {
            const search = document.getElementById('historySearch').value.toLowerCase();
            const container = document.getElementById('historyContainer');
            container.innerHTML = '';
            const filtered = history.filter(h => {
                const d = new Date(h.date).toLocaleDateString('bn-BD');
                return d.includes(search) || h.items.some(i => i.name.toLowerCase().includes(search));
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
            if (filtered.length === 0) {
                 container.innerHTML = `<div class="text-center py-10 opacity-50 fade-in"><i class="fas fa-box-open text-4xl mb-2 text-gray-300 dark:text-gray-600"></i><p class="text-gray-400 text-sm">‡¶ï‡ßã‡¶®‡ßã ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p></div>`;
                 return;
            }
            filtered.forEach(h => {
                const div = document.createElement('div');
                div.onclick = () => openHistoryDetail(h.id); 
                div.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm transition hover:shadow-md cursor-pointer fade-in';
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <p class="font-bold text-gray-800 dark:text-gray-200">${formatBnDate(h.date).split(',')[0]}</p>
                        <span class="font-bold text-primary dark:text-blue-400 text-2xl">‡ß≥ ${toBn(h.total)}</span>
                    </div>
                    <div class="flex justify-between items-center text-xs text-gray-500 dark:text-gray-400 mt-2">
                        <span>${toBn(h.items.length)} ‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ</span>
                        <span class="font-medium text-primary hover:underline">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® <i class="fas fa-arrow-right ml-1 text-sm"></i></span>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        function openHistoryDetail(id) {
            const entry = history.find(h => h.id === id);
            if (!entry) return;
            showPage('history-detail');
            renderHistoryDetail(entry);
        }
        function renderHistoryDetail(entry) {
            const headerEl = document.getElementById('historyDetailHeader');
            const listEl = document.getElementById('historyDetailList');
            listEl.innerHTML = '';
            const dateParts = formatBnDate(entry.date).split(',');
            document.getElementById('pageTitle').innerText = '‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§';
            headerEl.innerHTML = `
                <p class="text-xs text-gray-500 dark:text-gray-400 font-medium mb-1">${dateParts[0]}, ${dateParts[1]}</p>
                <div class="flex justify-between items-end">
                    <h2 class="text-3xl font-extrabold text-primary dark:text-blue-400">‡ß≥ ${toBn(entry.total)}</h2>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">${dateParts[2].trim()}</p>
                </div>
                <div class="h-px bg-gray-200 dark:bg-gray-700 my-3"></div>
                <p class="text-sm text-gray-600 dark:text-gray-400 font-bold">${toBn(entry.items.length)} ‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ:</p>
            `;
            entry.items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'history-item-detail fade-in';
                div.style.animationDelay = `${index * 50}ms`;
                let changeBadge = '';
                if (item.given > 0) {
                    const isPlus = item.change >= 0;
                    changeBadge = `<span class="ml-2 text-[10px] font-bold py-0.5 px-2 rounded-full ${isPlus ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} dark:bg-opacity-20 dark:${isPlus ? 'text-green-300' : 'text-red-300'}">‡¶´‡ßá‡¶∞‡¶§: ‡ß≥ ${toBn(Math.abs(item.change))}</span>`;
                }
                div.innerHTML = `
                    <div class="flex items-center gap-3 w-4/6">
                        <div class="text-xl">${item.icon}</div>
                        <div class="truncate">
                            <p class="font-bold text-sm text-gray-800 dark:text-gray-200">${item.name}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${toBn(item.w)} ${item.unit} x ‡ß≥${toBn(item.p)}</p>
                        </div>
                    </div>
                    <div class="text-right flex flex-col items-end">
                        <span class="font-extrabold text-lg text-secondary dark:text-purple-400">‡ß≥ ${toBn(item.cost)}</span>
                        ${changeBadge}
                    </div>
                `;
                listEl.appendChild(div);
            });
        }
        function openEditModal(id) {
            const item = items.find(i => i.id === id);
            if (!item) return;
            document.getElementById('editItemId').value = id;
            document.getElementById('editItemName').value = item.name;
            document.getElementById('editItemTags').value = item.tags ? item.tags.join(', ') : '';
            document.getElementById('editUnitPrice').value = item.p;
            document.getElementById('editWeight').value = item.w;
            weightUnit = item.unit;
            document.getElementById('editWeightUnit').innerText = item.unit === 'KG' ? '‡¶ï‡ßá‡¶ú‡¶ø' : '‡¶™‡¶ø‡¶∏';
            calculateEditLive();
            document.getElementById('editModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('editModalContent').classList.remove('opacity-0', 'scale-95'), 10);
        }
        function cycleEditUnit() {
            weightUnit = weightUnit === 'KG' ? 'PCS' : 'KG';
            document.getElementById('editWeightUnit').innerText = weightUnit === 'KG' ? '‡¶ï‡ßá‡¶ú‡¶ø' : '‡¶™‡¶ø‡¶∏';
            calculateEditLive();
        }
        function calculateEditLive() {
            const p = parseFloat(document.getElementById('editUnitPrice').value) || 0;
            const w = parseFloat(document.getElementById('editWeight').value) || 0;
            const cost = Math.round(p * w);
            document.getElementById('editLiveCost').innerText = '‡ß≥ ' + toBn(cost);
        }
        
        function saveEditedItem() {
            const id = parseInt(document.getElementById('editItemId').value);
            const idx = items.findIndex(i => i.id === id);
            if (!document.getElementById('editItemName').value.trim() || !document.getElementById('editUnitPrice').value || !document.getElementById('editWeight').value) {
                alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ, ‡¶¶‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§");
                return;
            }
            if (idx > -1) {
                const p = parseFloat(document.getElementById('editUnitPrice').value) || 0;
                const w = parseFloat(document.getElementById('editWeight').value) || 0;
                const tags = document.getElementById('editItemTags').value.trim();
                items[idx].name = document.getElementById('editItemName').value.trim();
                items[idx].tags = tags.split(/[\s,]+/).filter(tag => tag.startsWith('#') || tag.length > 0);
                items[idx].p = p;
                items[idx].w = w;
                items[idx].unit = weightUnit;
                items[idx].cost = Math.round(p * w);
                const originalGiven = items[idx].given || 0;
                items[idx].change = originalGiven > 0 ? originalGiven - items[idx].cost : null;
                priceMemory[items[idx].name] = p;
                localStorage.setItem('sb5_price_memory', JSON.stringify(priceMemory));
                document.getElementById('editModal').classList.add('hidden');
                document.getElementById('editModalContent').classList.add('opacity-0', 'scale-95');
                saveAndRender(); 
            }
        }
        
        function moveToWishlist(id) {
            const idx = items.findIndex(i => i.id === id);
            if(idx > -1) {
                const item = items.splice(idx, 1)[0];
                wishlist.unshift(item);
                localStorage.setItem('sb5_wishlist', JSON.stringify(wishlist));
                saveAndRender();
            }
        }
        function renderWishlist() {
            const container = document.getElementById('wishlistContainer');
            container.innerHTML = '';
            if (wishlist.length === 0) {
                container.innerHTML = `<div class="text-center py-10 opacity-50 fade-in"><i class="fas fa-heart-crack text-4xl mb-2 text-gray-300 dark:text-gray-600"></i><p class="text-gray-400 text-sm">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Buy Later ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø‡•§</p></div>`;
                return;
            }
            wishlist.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md border border-gray-100 dark:border-gray-700 flex justify-between items-center group transition hover:shadow-xl fade-in';
                div.innerHTML = `
                    <div class="flex items-center gap-3 w-3/5">
                        <div class="w-10 h-10 rounded-full bg-pink-50 dark:bg-pink-900/20 text-xl flex items-center justify-center">${item.icon}</div>
                        <div class="truncate">
                            <p class="font-bold text-gray-800 dark:text-gray-200 leading-tight">${item.name}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">${toBn(item.w)} ${item.unit} (~‡ß≥${toBn(item.cost)})</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="alert('‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡¶§ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞: ‡¶è‡¶á ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø ‡¶ï‡ßá‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∞‡¶ø‡¶Æ‡¶æ‡¶á‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§')" title="Set Reminder" class="w-8 h-8 rounded-full text-gray-400 hover:bg-purple-50 hover:text-purple-600 transition"><i class="fas fa-bell text-xs"></i></button>
                        <button onclick="moveFromWishlist(${item.id})" title="Move to Cart" class="w-8 h-8 rounded-full text-gray-400 hover:bg-green-50 hover:text-green-600 transition"><i class="fas fa-cart-plus text-xs"></i></button>
                        <button onclick="deleteFromWishlist(${item.id})" title="Delete" class="w-8 h-8 rounded-full text-gray-400 hover:bg-red-50 hover:text-red-500 transition"><i class="fas fa-times text-xs"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        function moveFromWishlist(id) {
            const idx = wishlist.findIndex(i => i.id === id);
            if(idx > -1) {
                const item = wishlist.splice(idx, 1)[0];
                items.unshift(item);
                localStorage.setItem('sb5_wishlist', JSON.stringify(wishlist));
                saveAndRender();
                renderWishlist();
            }
        }
        function deleteFromWishlist(id) {
            const idx = wishlist.findIndex(i => i.id === id);
            if(idx > -1) {
                wishlist.splice(idx, 1);
                localStorage.setItem('sb5_wishlist', JSON.stringify(wishlist));
                renderWishlist();
            }
        }
        function deleteItem(id) {
            const idx = items.findIndex(i => i.id === id);
            if(idx > -1) {
                deletedItem = { data: items[idx], index: idx };
                items.splice(idx, 1);
                saveAndRender();
                const toast = document.getElementById('undoToast');
                toast.classList.remove('hidden');
                clearTimeout(undoTimer);
                undoTimer = setTimeout(() => {
                    toast.classList.add('hidden');
                    deletedItem = null;
                }, 4000);
            }
        }
        function undoDelete() {
            if(deletedItem) {
                items.splice(deletedItem.index, 0, deletedItem.data);
                saveAndRender();
                document.getElementById('undoToast').classList.add('hidden');
                deletedItem = null;
            }
        }
        function confirmCheckout() {
            const total = items.reduce((a, b) => a + b.cost, 0);
            const totalGiven = items.reduce((a, b) => a + (b.given > 0 ? b.given : 0), 0);
            const finalChange = totalGiven - total;
            document.getElementById('checkoutTotal').innerText = `‡ß≥ ${toBn(total)}`;
            document.getElementById('checkoutGiven').innerText = `‡ß≥ ${toBn(totalGiven)}`;
            document.getElementById('checkoutChange').innerText = `‡ß≥ ${toBn(Math.abs(finalChange))}`;
            const changeRow = document.getElementById('checkoutChangeRow');
            changeRow.classList.remove('text-primary', 'dark:text-blue-400', 'text-red-600', 'dark:text-red-400');
            if (finalChange >= 0) {
                changeRow.querySelector('span:first-child').innerText = '‡¶´‡ßá‡¶∞‡¶§ ‡¶™‡¶æ‡¶¨‡ßá‡¶®:';
                changeRow.classList.add('text-primary', 'dark:text-blue-400');
            } else {
                changeRow.querySelector('span:first-child').innerText = '‡¶Ü‡¶∞‡ßã ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá:';
                changeRow.classList.add('text-red-600', 'dark:text-red-400');
            }
            const itemListEl = document.getElementById('checkoutItemList');
            if (items.length === 0) {
                 itemListEl.innerHTML = `<p class="text-sm text-center text-gray-500 py-2">‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶®‡ßá‡¶á‡•§</p>`;
            } else {
                itemListEl.innerHTML = items.map(item => `
                    <div class="flex justify-between items-center text-xs dark:text-gray-300">
                        <span class="truncate">${item.icon} ${item.name} <span class="text-gray-500">(${toBn(item.w)} ${item.unit})</span></span>
                        <span class="font-bold text-gray-800 dark:text-gray-200">‡ß≥ ${toBn(item.cost)}</span>
                    </div>
                `).join('');
            }
            document.getElementById('confirmModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('confirmModalContent').classList.remove('opacity-0', 'scale-95'), 10);
        }
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            document.getElementById('confirmModalContent').classList.add('opacity-0', 'scale-95');
        }
        function performCheckout() {
            closeConfirmModal();
            const total = items.reduce((a, b) => a + b.cost, 0);
            wallet -= total;
            localStorage.setItem('sb5_wallet', wallet);
            history.unshift({
                id: Date.now(),
                date: new Date().toISOString(),
                total,
                items: [...items]
            });
            localStorage.setItem('sb5_history', JSON.stringify(history));
            items = [];
            saveAndRender();
            const oldTitle = document.getElementById('pageTitle').innerText;
            document.getElementById('pageTitle').innerHTML = '‚úÖ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®! ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ‡ß≥ ' + toBn(wallet);
            setTimeout(() => {
                document.getElementById('pageTitle').innerHTML = '<i class="fas fa-cart-shopping mr-1 text-white"></i>‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞';
            }, 3000);
        }
        function saveAndRender() { localStorage.setItem('sb5_cart', JSON.stringify(items)); renderHome(); }
        function toggleMenu() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            if(sb.classList.contains('-translate-x-full')) {
                sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden');
            } else {
                sb.classList.add('-translate-x-full'); ov.classList.add('hidden');
            }
        }
        function toggleFilter() {
            const searchInput = document.getElementById('listSearch');
            searchInput.classList.toggle('hidden');
            if (!searchInput.classList.contains('hidden')) {
                searchInput.focus();
            } else {
                searchInput.value = '';
                renderHome();
            }
        }
        function openWalletModal() { 
            document.getElementById('walletModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('walletModalContent').classList.remove('opacity-0', 'scale-95'), 10);
            if(wallet>0) document.getElementById('walletInput').value = wallet;
        }
        function saveWallet() {
            const w = parseFloat(document.getElementById('walletInput').value);
            if(w >= 0) { wallet = w; localStorage.setItem('sb5_wallet', wallet); document.getElementById('walletModal').classList.add('hidden'); renderHome(); }
        }
        function setWallet(v) { document.getElementById('walletInput').value = v; }
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            isDarkMode = !isDarkMode;
            localStorage.setItem('sb5_theme', isDarkMode ? 'dark' : 'light');
            document.getElementById('themeIcon').className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
            if (myChart) {
                myChart.options.plugins.legend.labels.color = isDarkMode ? '#f1f5f9' : '#1e293b';
                myChart.update();
            }
        }
        function editProfile() {
            const n = prompt("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:", userName);
            if(n) { userName = n; localStorage.setItem('sb5_user', n); renderHome(); }
        }
        function resetAll() {
             if (window.confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶°‡ßá‡¶ü‡¶æ (‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ, ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏, ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏, ‡¶®‡¶æ‡¶Æ) ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶∞‡ßÇ‡¶™‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
                localStorage.clear();
                location.reload();
            }
        }
        function populateIconModal() {
            const grid = document.getElementById('iconGrid');
            const allIcons = emojiIcons.concat(Object.values(suggestions).flat().map(i => i.icon));
            const uniqueIcons = [...new Set(allIcons)].slice(0, 50);
            grid.innerHTML = uniqueIcons.map(icon => 
                `<span onclick="selectIcon('${icon}')" class="cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 p-1 rounded transition text-center active:scale-90">${icon}</span>`
            ).join('');
        }
        function openIconModal() {
            document.getElementById('iconModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('iconModalContent').classList.remove('opacity-0', 'scale-95'), 10);
        }
        function closeIconModal() {
            document.getElementById('iconModal').classList.add('hidden');
            document.getElementById('iconModalContent').classList.add('opacity-0', 'scale-95');
        }
        function selectIcon(icon) {
            selectedIcon = icon;
            localStorage.setItem('sb5_default_icon', icon);
            document.getElementById('selectedIcon').innerText = icon;
            closeIconModal();
        }
        
        const suggestions = {
            '‡¶Æ‡¶æ‡¶õ/‡¶Æ‡¶æ‡¶Ç‡¶∏': [
                {name: '‡¶¨‡ßç‡¶∞‡ßü‡¶≤‡¶æ‡¶∞ ‡¶Æ‡ßÅ‡¶∞‡¶ó‡¶ø', icon: 'üêî'}, {name: '‡¶∏‡ßã‡¶®‡¶æ‡¶≤‡¶ø ‡¶Æ‡ßÅ‡¶∞‡¶ó‡¶ø', icon: 'üçó'}, 
                {name: '‡¶ó‡¶∞‡ßÅ‡¶∞ ‡¶Æ‡¶æ‡¶Ç‡¶∏', icon: 'ü•©'}, {name: '‡¶ñ‡¶æ‡¶∏‡¶ø‡¶∞ ‡¶Æ‡¶æ‡¶Ç‡¶∏', icon: 'üêê'},
                {name: '‡¶∞‡ßÅ‡¶á ‡¶Æ‡¶æ‡¶õ', icon: 'üêü'}, {name: '‡¶á‡¶≤‡¶ø‡¶∂ ‡¶Æ‡¶æ‡¶õ', icon: 'üê†'},
                {name: '‡¶™‡¶æ‡¶ô‡ßç‡¶ó‡¶æ‡¶∏', icon: 'üê°'}, {name: '‡¶§‡ßá‡¶≤‡¶æ‡¶™‡¶ø‡ßü‡¶æ', icon: 'üê†'},
                {name: '‡¶ö‡¶ø‡¶Ç‡ßú‡¶ø', icon: 'ü¶ê'}, {name: '‡¶°‡¶ø‡¶Æ (‡¶°‡¶ú‡¶®)', icon: 'ü•ö'},
                {name: '‡¶π‡¶æ‡¶Å‡¶∏‡ßá‡¶∞ ‡¶°‡¶ø‡¶Æ', icon: 'ü¶¢'}, {name: '‡¶ï‡¶¨‡ßÅ‡¶§‡¶∞‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶Ç‡¶∏', icon: 'üïäÔ∏è'},
                {name: '‡¶ï‡ßà ‡¶Æ‡¶æ‡¶õ', icon: 'üé£'}, {name: '‡¶∂‡¶ø‡¶Ç ‡¶Æ‡¶æ‡¶õ', icon: 'üêü'}
            ],
            '‡¶∂‡¶æ‡¶ï‡¶∏‡¶¨‡¶ú‡¶ø': [
                {name: '‡¶Ü‡¶≤‡ßÅ', icon: 'ü•î'}, {name: '‡¶™‡ßá‡¶Å‡ßü‡¶æ‡¶ú', icon: 'üßÖ'}, 
                {name: '‡¶∞‡¶∏‡ßÅ‡¶®', icon: 'üßÑ'}, {name: '‡¶Ü‡¶¶‡¶æ', icon: 'üç†'},
                {name: '‡¶ï‡¶æ‡¶Å‡¶ö‡¶æ ‡¶Æ‡¶∞‡¶ø‡¶ö', icon: 'üå∂Ô∏è'}, {name: '‡¶ü‡¶Æ‡ßá‡¶ü‡ßã', icon: 'üçÖ'},
                {name: '‡¶¨‡ßá‡¶ó‡ßÅ‡¶®', icon: 'üçÜ'}, {name: '‡¶∂‡¶∏‡¶æ', icon: 'ü•í'},
                {name: '‡¶ó‡¶æ‡¶ú‡¶∞', icon: 'ü•ï'}, {name: '‡¶´‡ßÅ‡¶≤‡¶ï‡¶™‡¶ø', icon: 'ü•¶'},
                {name: '‡¶¨‡¶æ‡¶Å‡¶ß‡¶æ‡¶ï‡¶™‡¶ø', icon: 'ü•¨'}, {name: '‡¶ï‡¶≤‡¶æ', icon: 'üçå'},
                {name: '‡¶Ü‡¶™‡ßá‡¶≤', icon: 'üçé'}, {name: '‡¶ï‡¶Æ‡¶≤‡¶æ', icon: 'üçä'},
                {name: '‡¶Ü‡¶Æ', icon: 'ü•≠'}, {name: '‡¶≤‡ßá‡¶¨‡ßÅ', icon: 'üçã'}
            ],
            '‡¶Æ‡ßÅ‡¶¶‡¶ø': [
                {name: '‡¶Æ‡¶ø‡¶®‡¶ø‡¶ï‡ßá‡¶ü ‡¶ö‡¶æ‡¶≤', icon: 'üçö'}, {name: '‡¶®‡¶æ‡¶ú‡¶ø‡¶∞‡¶∂‡¶æ‡¶á‡¶≤', icon: 'üçö'},
                {name: '‡¶∏‡ßü‡¶æ‡¶¨‡¶ø‡¶® ‡¶§‡ßá‡¶≤', icon: 'üçæ'}, {name: '‡¶Æ‡¶∏‡ßÅ‡¶∞ ‡¶°‡¶æ‡¶≤', icon: 'ü•£'},
                {name: '‡¶ö‡¶ø‡¶®‡¶ø', icon: 'üç¨'}, {name: '‡¶≤‡¶¨‡¶£', icon: 'üßÇ'},
                {name: '‡¶Ü‡¶ü‡¶æ', icon: 'üçû'}, {name: '‡¶∏‡ßÅ‡¶ú‡¶ø', icon: 'ü•£'},
                {name: '‡¶ö‡¶æ ‡¶™‡¶æ‡¶§‡¶æ', icon: '‚òï'}, {name: '‡¶ï‡¶´‡¶ø', icon: '‚òï'},
                {name: '‡¶π‡¶≤‡ßÅ‡¶¶ ‡¶ó‡ßÅ‡¶Å‡ßú‡¶æ', icon: 'üå∂Ô∏è'}, {name: '‡¶Æ‡¶∞‡¶ø‡¶ö ‡¶ó‡ßÅ‡¶Å‡ßú‡¶æ', icon: 'üå∂Ô∏è'}
            ],
            '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø': [
                {name: '‡¶∏‡¶æ‡¶¨‡¶æ‡¶®', icon: 'üßº'}, {name: '‡¶∂‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™‡ßÅ', icon: 'üß¥'},
                {name: '‡¶ü‡ßÅ‡¶•‡¶™‡ßá‡¶∏‡ßç‡¶ü', icon: 'ü¶∑'}, {name: '‡¶ü‡¶ø‡¶∏‡ßç‡¶Ø‡ßÅ', icon: 'üßª'},
                {name: '‡¶°‡¶ø‡¶ü‡¶æ‡¶∞‡¶ú‡ßá‡¶®‡ßç‡¶ü', icon: 'üß∫'}, {name: '‡¶¨‡¶ø‡¶∏‡ßç‡¶ï‡ßÅ‡¶ü', icon: 'üç™'},
                {name: '‡¶™‡¶æ‡¶ì‡¶°‡¶æ‡¶∞ ‡¶¶‡ßÅ‡¶ß', icon: 'ü•õ'}, {name: '‡¶¨‡¶æ‡¶ü‡¶æ‡¶∞', icon: 'üßà'},
                {name: '‡¶Æ‡ßã‡¶Æ‡¶¨‡¶æ‡¶§‡¶ø', icon: 'üïØÔ∏è'}, {name: '‡¶¨‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡¶ø', icon: 'üîã'}
            ]
        };
        
        function exportData() {
            const data = { items, wishlist, wallet, history, userName, priceMemory, monthlyBudget, appCategories, notes };
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `smart_bazar_data_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function importDataModal() {
            document.getElementById('importModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('importModalContent').classList.remove('opacity-0', 'scale-95'), 10);
        }

        function importData() {
            const jsonText = document.getElementById('importJsonArea').value;
            try {
                const data = JSON.parse(jsonText);
                items = data.items || [];
                wishlist = data.wishlist || [];
                wallet = data.wallet || 0;
                history = data.history || [];
                notes = data.notes || []; 
                userName = data.userName || '‡¶¨‡¶®‡ßç‡¶ß‡ßÅ';
                priceMemory = data.priceMemory || {};
                monthlyBudget = data.monthlyBudget || 0;
                appCategories = data.appCategories || appCategories;

                localStorage.setItem('sb5_cart', JSON.stringify(items));
                localStorage.setItem('sb5_wishlist', JSON.stringify(wishlist));
                localStorage.setItem('sb5_wallet', wallet);
                localStorage.setItem('sb5_history', JSON.stringify(history));
                localStorage.setItem('sb5_notes', JSON.stringify(notes)); 
                localStorage.setItem('sb5_user', userName);
                localStorage.setItem('sb5_price_memory', JSON.stringify(priceMemory));
                localStorage.setItem('sb5_budget', monthlyBudget);
                localStorage.setItem('sb5_categories', JSON.stringify(appCategories));
                
                document.getElementById('importModal').classList.add('hidden');
                updateCategoryDropdown();
                renderHome();
                renderNotepad(); 
                
            } catch (e) {
                alert("‡¶°‡ßá‡¶ü‡¶æ ‡¶á‡¶Æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§");
            }
        }
        
        let myChart = null;
        function renderStats() {
            const categoryTotals = {};
            let totalSpent = 0;
            history.forEach(shop => {
                shop.items.forEach(item => {
                    const catName = item.cat;
                    const cost = item.cost;
                    categoryTotals[catName] = (categoryTotals[catName] || 0) + cost;
                    totalSpent += cost;
                });
            });
            const categories = Object.keys(categoryTotals);
            const data = categories.map(cat => categoryTotals[cat]);
            const colors = categories.map(cat => appCategories[cat] ? appCategories[cat].color : '#cccccc');
            const chartCanvas = document.getElementById('categoryChart').getContext('2d');
            if (myChart) {
                myChart.destroy();
            }
            myChart = new Chart(chartCanvas, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: isDarkMode ? '#f1f5f9' : '#1e293b', font: { family: 'Hind Siliguri' } } },
                        title: { display: false }
                    }
                }
            });
            const summaryEl = document.getElementById('statsSummary');
            summaryEl.innerHTML = '';
            const sortedCategories = Object.entries(categoryTotals).sort(([,a], [,b]) => b - a);
            summaryEl.innerHTML += `<p class="text-xl font-extrabold text-primary dark:text-blue-400">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö: ‡ß≥ ${toBn(totalSpent)}</p>`;
            summaryEl.innerHTML += `<div class="h-px bg-gray-200 dark:bg-gray-700 my-2"></div>`;
            sortedCategories.forEach(([cat, cost]) => {
                const percentage = totalSpent > 0 ? ((cost / totalSpent) * 100).toFixed(1) : 0;
                summaryEl.innerHTML += `
                    <div class="flex justify-between items-center text-sm font-medium dark:text-gray-300">
                        <span>${appCategories[cat] ? appCategories[cat].icon : '‚ùì'} ${cat}</span>
                        <span>‡ß≥ ${toBn(cost)} (${toBn(percentage)}%)</span>
                    </div>
                `;
            });
        }
        
        function renderPriceTracker() {
            const priceTracker = {}; 
            history.forEach(shop => {
                shop.items.forEach(item => {
                    const name = item.name;
                    if (!priceTracker[name]) {
                        priceTracker[name] = { count: 0, totalCost: 0, avgPrice: 0, prices: [] };
                    }
                    priceTracker[name].count += 1;
                    priceTracker[name].totalCost += item.p;
                    priceTracker[name].prices.push({ date: shop.date, price: item.p });
                });
            });
            Object.keys(priceTracker).forEach(name => {
                const tracker = priceTracker[name];
                tracker.avgPrice = tracker.totalCost / tracker.count;
                tracker.prices.sort((a, b) => new Date(b.date) - new Date(a.date));
                const latestPrice = tracker.prices[0].price;
                const previousPrice = tracker.prices.length > 1 ? tracker.prices[1].price : latestPrice;
                tracker.trend = latestPrice > previousPrice ? 'up' : latestPrice < previousPrice ? 'down' : 'stable';
                tracker.latestPrice = latestPrice;
                tracker.previousPrice = previousPrice;
            });
            const container = document.getElementById('priceTrackerContainer');
            container.innerHTML = '';
            const sortedTracker = Object.entries(priceTracker).sort(([,a], [,b]) => b.avgPrice - a.avgPrice);
            if (sortedTracker.length === 0) {
                 container.innerHTML = `<p class="text-center py-5 text-gray-400">‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á‡•§</p>`;
                 return;
            }
            sortedTracker.forEach(([name, tracker]) => {
                let trendIcon = '';
                let trendColor = 'text-gray-500';
                if (tracker.trend === 'up') {
                    trendIcon = '<i class="fas fa-arrow-up"></i>';
                    trendColor = 'text-red-500';
                } else if (tracker.trend === 'down') {
                    trendIcon = '<i class="fas fa-arrow-down"></i>';
                    trendColor = 'text-green-500';
                } else {
                    trendIcon = '<i class="fas fa-minus"></i>';
                }
                const div = document.createElement('div');
                div.className = 'bg-gray-50 dark:bg-gray-800 p-4 rounded-xl flex justify-between items-center border dark:border-gray-700';
                div.innerHTML = `
                    <div class="flex flex-col">
                        <p class="font-bold dark:text-white">${name}</p>
                        <p class="text-xs text-gray-500">‡¶ó‡¶°‡¶º ‡¶¶‡¶æ‡¶Æ: ‡ß≥ ${toBn(tracker.avgPrice.toFixed(2))}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-extrabold text-xl ${trendColor}">‡ß≥ ${toBn(tracker.latestPrice)} ${trendIcon}</p>
                        ${tracker.prices.length > 1 ? `<p class="text-xs text-gray-500">‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶¶‡¶æ‡¶Æ: ‡ß≥ ${toBn(tracker.previousPrice)}</p>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }
    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful:', registration.scope);
                    }, err => {
                        console.log('ServiceWorker registration failed:', err);
                    });
            });
        }
    </script>
</body>
</html>